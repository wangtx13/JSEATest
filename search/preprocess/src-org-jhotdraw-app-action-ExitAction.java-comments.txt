/* * @ # exit action 1 0 04 january 2005 * * copyright c 1996 2006 by the original authors of * and all its contributors * all rights reserved * * software is the confidential and proprietary information of * confidential information you shall not disclose * such confidential information and shall use it only in accordance * with the terms of the license agreement you entered into with * */package app action gui * gui event * * * event * * * io * app application app project /** * exits the application after letting the user save or close unsaved projects * * @author werner randelshofer * @version 1 0 04 january 2005 created */public exit action application action { = exit component old focus owner project unsaved project /** creates a instance */ exit action application app { app resource bundle labels = resource bundle get l a f bundle app labels labels configure action } action performed action event evt { application app = get application app is enabled { app set enabled unsaved projects count = 0 project document to be reviewed = project p app projects { p has unsaved changes { p is enabled { document to be reviewed = p } unsaved projects count++ } } unsaved projects count > 0 document to be reviewed == { silently abort no project can be reviewed app set enabled } unsaved projects count { 0 { exit } 1 { unsaved project = document to be reviewed old focus owner = utilities get window ancestor unsaved project get component get focus owner unsaved project set enabled j option pane pane = j option pane <html> + u i manager get option pane css + <b> you want to save changes to document + before exiting?</b><p> + you don't save your changes will be lost j option pane w a r n i n g m e s s a g e options = { save cancel don't save } pane set options options pane set initial value options 0 pane put client property quaqua option pane destructive option 2 j sheet show sheet pane unsaved project get component sheet listener { option selected sheet event evt { value = evt get value value == || value equals cancel { unsaved project set enabled app set enabled } value equals don't save { exit unsaved project set enabled } value equals save { save changes } } } } { j option pane pane = j option pane <html> + u i manager get option pane css + <b> you have +unsaved projects count+ documents with unsaved changes + you want to + review these changes before quitting?</b><p> + you don't review your documents + all your changes will be lost j option pane q u e s t i o n m e s s a g e options = { review changes cancel discard changes } pane set options options pane set initial value options 0 pane put client property quaqua option pane destructive option 2 j dialog dialog = pane create dialog app get component dialog set visible value = pane get value value == || value equals cancel { app set enabled } value equals discard changes { exit app set enabled } value equals review changes { unsaved project = document to be reviewed review changes } } } } } save changes { unsaved project get == { j chooser chooser = unsaved project get save chooser option = chooser show save dialog j sheet show save sheet chooser unsaved project get component sheet listener { option selected sheet event evt { evt get option == j chooser a p p r o v e o p t i o n { = evt get chooser get selected save to } { unsaved project set enabled old focus owner != { old focus owner request focus } get application set enabled } } } } { save to unsaved project get } } review changes { unsaved project is enabled { old focus owner = utilities get window ancestor unsaved project get component get focus owner unsaved project set enabled j option pane pane = j option pane <html> + u i manager get option pane css + <b> you want to save changes to document + before exiting?</b><p> + you don't save your changes will be lost j option pane w a r n i n g m e s s a g e options = { save cancel don't save } pane set options options pane set initial value options 0 pane put client property quaqua option pane destructive option 2 j sheet show sheet pane unsaved project get component sheet listener { option selected sheet event evt { value = evt get value value == || value equals cancel { unsaved project set enabled get application set enabled } value equals don't save { get application dispose unsaved project review next } value equals save { save changes and review next } } } } { get application set enabled out review silently aborted } } save changes and review next { unsaved project get == { j chooser chooser = unsaved project get save chooser option = chooser show save dialog j sheet show save sheet chooser unsaved project get component sheet listener { option selected sheet event evt { evt get option == j chooser a p p r o v e o p t i o n { = evt get chooser get selected save to and review next } { unsaved project set enabled old focus owner != { old focus owner request focus } get application set enabled } } } } { save to and review next unsaved project get } } review next { unsaved projects count = 0 project document to be reviewed = project p get application projects { p has unsaved changes { p is enabled { document to be reviewed = p } unsaved projects count++ } } unsaved projects count == 0 { exit } document to be reviewed != { unsaved project = document to be reviewed review changes } { get application set enabled out exit silently aborted } } save to { unsaved project execute worker { construct { { unsaved project write } i o e { e } } finished value { saved unsaved project value } } } save to and review next { unsaved project execute worker { construct { { unsaved project write } i o e { e } } finished value { saved and review next unsaved project value } } } saved project unsaved project value { value == { unsaved project set exit } { j sheet show message sheet unsaved project get component <html> + u i manager get option pane css + <b> couldn't save to the \ +file+ \ <p> + reason +value j option pane e r r o r m e s s a g e } unsaved project set enabled old focus owner != { old focus owner request focus } get application set enabled } saved and review next project unsaved project value { value == { unsaved project set get application dispose unsaved project review next } { j sheet show message sheet unsaved project get component <html> + u i manager get option pane css + <b> couldn't save to the \ +file+ \ <p> + reason +value j option pane e r r o r m e s s a g e } unsaved project set enabled old focus owner != { old focus owner request focus } get application set enabled } exit { get application stop exit 0 }} 